<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background-color: rgba(59, 130, 246, 0.5);
      border-radius: 10px;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- ‚úÖ Top Navigation Menu -->
  <nav class="bg-blue-600 text-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="text-xl font-bold">Admin Panel</div>
      <ul class="flex gap-6 font-medium">
        <li><a href="index.html" class="nav-link hover:underline hover:text-yellow-300 transition">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</a></li>
        <li><a href="addevent.html" class="nav-link hover:underline hover:text-yellow-300 transition">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Event</a></li>
        <li><a href="admin.html" class="nav-link hover:underline hover:text-yellow-300 transition">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</a></li>
      </ul>
      <button id="logoutBtn" class="ml-4 text-sm hover:underline text-red-200 hover:text-white">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </nav>

  <!-- ‚úÖ Main Content -->
  <main class="flex-grow max-w-7xl mx-auto px-4 py-6">
    <section class="bg-white rounded-xl shadow p-6">
      <h2 class="text-xl font-semibold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>

      <!-- üîç Search -->
      <input
        type="text"
        id="searchInput"
        placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°..."
        class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-400"
      />

      <!-- üë• User Table -->
      <div class="overflow-x-auto max-h-[450px]">
        <table class="min-w-full table-auto border-collapse border border-gray-200">
          <thead class="bg-blue-100 sticky top-0">
            <tr>
              <th class="border border-gray-300 px-4 py-2 text-left">Username</th>
              <th class="border border-gray-300 px-4 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°</th>
              <th class="border border-gray-300 px-4 py-2 text-left">Role</th>
              <th class="border border-gray-300 px-4 py-2 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</th>
              <th class="border border-gray-300 px-4 py-2 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="userTableBody" class="text-gray-700 max-h-[400px] overflow-y-auto">
            <!-- ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
          </tbody>
        </table>
      </div>

      <!-- üìù Add/Edit User Form -->
      <div class="mt-8 border-t pt-6">
        <h3 id="formTitle" class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</h3>
        <form id="userForm" class="space-y-4 max-w-md">
          <input type="hidden" id="userId" />

          <input
            type="text"
            id="username"
            placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (username)"
            required
            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
          />
          <input
            type="text"
            id="fullName"
            placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°"
            required
            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
          />
          <input
            type="password"
            id="password"
            placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"
            required
            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
          />
          <select
            id="role"
            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
            required
          >
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>

          <div class="flex gap-4">
            <button
              type="submit"
              id="saveBtn"
              class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700 transition"
            >‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button
              type="button"
              id="cancelBtn"
              class="bg-gray-300 text-gray-700 py-2 px-6 rounded-lg hover:bg-gray-400 transition"
            >‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <!-- ‚úÖ Script -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabase = createClient(
      'https://yyxovuybwuqvgtikujyi.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5eG92dXlid3Vxdmd0aWt1anlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwODE3MzQsImV4cCI6MjA2NjY1NzczNH0.QgvI_-w55PFXY0oz8U4ZeqFp4RDQlNFEMA4B40kkVtQ'
    )

    // üîê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session
    const user = JSON.parse(localStorage.getItem('user') || '{}')
    if (!user.id || user.role !== 'admin') {
      alert('‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô')
      location.href = 'login.html'
    }

    // üåê Navigation Active Highlight
    const current = location.pathname.split('/').pop()
    document.querySelectorAll('.nav-link').forEach(link => {
      if (link.getAttribute('href') === current) {
        link.classList.add('underline', 'font-bold', 'text-yellow-300')
      } else {
        link.classList.remove('underline', 'font-bold', 'text-yellow-300')
      }
    })

    const userTableBody = document.getElementById('userTableBody')
    const searchInput = document.getElementById('searchInput')
    const userForm = document.getElementById('userForm')
    const formTitle = document.getElementById('formTitle')
    const userIdInput = document.getElementById('userId')
    const usernameInput = document.getElementById('username')
    const fullNameInput = document.getElementById('fullName')
    const passwordInput = document.getElementById('password')
    const roleSelect = document.getElementById('role')
    const cancelBtn = document.getElementById('cancelBtn')

    let allUsers = []
    let editMode = false

    // üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    async function loadUsers() {
      const { data, error } = await supabase.from('users').select('*').order('created_at', { ascending: false })
      if (error) {
        alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message)
        return
      }
      allUsers = data
      renderUserTable(data)
    }

    // üßæ ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    function renderUserTable(users) {
      if (!users.length) {
        userTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</td></tr>`
        return
      }
      userTableBody.innerHTML = users.map(u => `
        <tr class="hover:bg-gray-50">
          <td class="border border-gray-300 px-4 py-2">${u.username}</td>
          <td class="border border-gray-300 px-4 py-2">${u.full_name || ''}</td>
          <td class="border border-gray-300 px-4 py-2 capitalize">${u.role}</td>
          <td class="border border-gray-300 px-4 py-2">${new Date(u.created_at).toLocaleString()}</td>
          <td class="border border-gray-300 px-4 py-2 text-center space-x-2">
            <button data-id="${u.id}" class="editBtn text-blue-600 hover:underline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button data-id="${u.id}" class="deleteBtn text-red-600 hover:underline">‡∏•‡∏ö</button>
          </td>
        </tr>
      `).join('')
      attachTableEvents()
    }

    // ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö
    function attachTableEvents() {
      document.querySelectorAll('.editBtn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id
          const user = allUsers.find(u => u.id === id)
          if (!user) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')
          editMode = true
          formTitle.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'
          userIdInput.value = user.id
          usernameInput.value = user.username
          fullNameInput.value = user.full_name || ''
          passwordInput.value = user.password || ''
          roleSelect.value = user.role
          window.scrollTo({ top: 0, behavior: 'smooth' })
        }
      })
      document.querySelectorAll('.deleteBtn').forEach(btn => {
        btn.onclick = async () => {
          if (!confirm('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return
          const id = btn.dataset.id
          const { error } = await supabase.from('users').delete().eq('id', id)
          if (error) return alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message)
          alert('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')
          loadUsers()
        }
      })
    }

    // üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    searchInput.addEventListener('input', e => {
      const q = e.target.value.toLowerCase()
      const filtered = allUsers.filter(
        u => u.username.toLowerCase().includes(q) || (u.full_name && u.full_name.toLowerCase().includes(q))
      )
      renderUserTable(filtered)
    })

    // üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    userForm.addEventListener('submit', async e => {
      e.preventDefault()
      const id = userIdInput.value
      const username = usernameInput.value.trim()
      const full_name = fullNameInput.value.trim()
      const password = passwordInput.value.trim()
      const role = roleSelect.value

      if (!username || !password) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö')

      const payload = { username, full_name, password, role }

      const { error } = editMode
        ? await supabase.from('users').update(payload).eq('id', id)
        : await supabase.from('users').insert([payload])

      if (error) return alert(error.message)
      alert(editMode ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')
      editMode = false
      userForm.reset()
      formTitle.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà'
      loadUsers()
    })

    cancelBtn.onclick = () => {
      editMode = false
      userForm.reset()
      formTitle.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà'
    }

    // üö™ Logout
    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('user')
      location.href = 'login.html'
    }

    loadUsers()
  </script>
</body>
</html>
