<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>

<!-- ‚úÖ FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  
  <style>
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background-color: rgba(59, 130, 246, 0.5);
      border-radius: 10px;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex">

  <!-- Sidebar -->
  <aside class="w-64 bg-white shadow h-screen sticky top-0 p-6 space-y-4">
    <div class="text-xl font-bold text-blue-600 mb-4">Admin Panel</div>
    <nav class="flex flex-col gap-2">
      <button class="tab-btn text-left px-4 py-2 rounded hover:bg-blue-50" data-target="calendar">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</button>
      <button class="tab-btn text-left px-4 py-2 rounded hover:bg-blue-50" data-target="event">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Event</button>
      <button class="tab-btn text-left px-4 py-2 rounded hover:bg-blue-50 text-blue-700 font-semibold " data-target="user">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
      <button id="logoutBtn" class="tab-btn text-left px-4 py-2 rounded hover:bg-blue-50 text-red-500 mt-8 ">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </nav>
  </aside>

  <!-- Content Area -->
  <main class="flex-grow max-w-7xl mx-auto px-4 py-6 space-y-6">

    <!-- Calendar -->
    <section id="section-calendar" class="hidden">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-4">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h2>
        <p>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏™‡πà calendar.js ‡∏´‡∏£‡∏∑‡∏≠ FullCalendar ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ</p>
        <div id="calendar" class="bg-white p-6 rounded-2xl shadow-lg"></div>
      </div>
    </section>

    <!-- Event List -->
    <section id="section-event" class="hidden">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-4">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Event</h2>
        <p>‡πÉ‡∏™‡πà‡∏ï‡∏≤‡∏£‡∏≤‡∏á event ‡∏´‡∏£‡∏∑‡∏≠ form ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
      </div>
    </section>

    <!-- User Management -->
    <section id="section-user">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-4">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>

        <input id="searchInput" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..."
          class="w-full px-4 py-2 border rounded-lg mb-4" />

        <div class="overflow-x-auto">
          <table class="min-w-full table-auto border">
            <thead class="bg-blue-100">
              <tr>
                <th class="border px-4 py-2">Username</th>
                <th class="border px-4 py-2">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°</th>
                <th class="border px-4 py-2">Role</th>
                <th class="border px-4 py-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                <th class="border px-4 py-2">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
          </table>
        </div>

        <form id="userForm" class="space-y-4 mt-6">
          <input type="hidden" id="userId" />
          <input type="text" id="username" placeholder="Username" required class="w-full px-4 py-2 border rounded-lg" />
          <input type="text" id="fullName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°" required class="w-full px-4 py-2 border rounded-lg" />
          <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required class="w-full px-4 py-2 border rounded-lg" />
          <select id="role" class="w-full px-4 py-2 border rounded-lg">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
          <div class="flex gap-4">
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button type="button" id="cancelBtn" class="bg-gray-300 px-4 py-2 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <!-- Script -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    const supabase = createClient('https://yyxovuybwuqvgtikujyi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5eG92dXlid3Vxdmd0aWt1anlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwODE3MzQsImV4cCI6MjA2NjY1NzczNH0.QgvI_-w55PFXY0oz8U4ZeqFp4RDQlNFEMA4B40kkVtQ')

    const user = JSON.parse(localStorage.getItem('user') || '{}')
    if (!user.id || user.role !== 'admin') {
      alert('‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô')
      location.href = 'login.html'
    }

    const tabButtons = document.querySelectorAll('.tab-btn')
    const sections = {
      calendar: document.getElementById('section-calendar'),
      event: document.getElementById('section-event'),
      user: document.getElementById('section-user')
    }
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.target
        for (let key in sections) {
          sections[key].classList.toggle('hidden', key !== target)
        }
        tabButtons.forEach(b => b.classList.remove('text-blue-700', 'font-semibold', 'underline'))
        btn.classList.add('text-blue-700', 'font-semibold', 'underline')
      })
    })

    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('user')
      location.href = 'index.html'
    }



 window.addEventListener('load', async () => {
  const { data: events } = await supabase.from('events').select('*')

  const calendarEl = document.getElementById('calendar')
  if (!calendarEl) return

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,listWeek'
    },
    locale: 'th',
    events: events.map(ev => ({
      title: ev.title,
      start: ev.start_date,
      end: ev.end_date,
      url: ev.file_url,
      description: ev.description
    })),
    eventClick: function (info) {
      if (!info.event.url) return
      info.jsEvent.preventDefault()
      window.open(info.event.url, '_blank')
    }
  })

  calendar.render()
})



    
    const userForm = document.getElementById('userForm')
    const userIdInput = document.getElementById('userId')
    const usernameInput = document.getElementById('username')
    const fullNameInput = document.getElementById('fullName')
    const passwordInput = document.getElementById('password')
    const roleSelect = document.getElementById('role')
    const cancelBtn = document.getElementById('cancelBtn')
    const userTableBody = document.getElementById('userTableBody')
    const searchInput = document.getElementById('searchInput')

    let allUsers = []
    let editMode = false

    async function loadUsers() {
      const { data, error } = await supabase.from('users').select('*').order('created_at', { ascending: false })
      if (error) return alert('‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß')
      allUsers = data
      renderUserTable(data)
    }

    function renderUserTable(users) {
      if (!users.length) {
        userTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'
        return
      }
      userTableBody.innerHTML = users.map(u => `
        <tr>
          <td class="border px-4 py-2">${u.username}</td>
          <td class="border px-4 py-2">${u.full_name || ''}</td>
          <td class="border px-4 py-2">${u.role}</td>
          <td class="border px-4 py-2">${new Date(u.created_at).toLocaleString()}</td>
          <td class="border px-4 py-2 space-x-2 text-center">
            <button class="editBtn text-blue-600" data-id="${u.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="deleteBtn text-red-600" data-id="${u.id}">‡∏•‡∏ö</button>
          </td>
        </tr>`).join('')
      attachTableEvents()
    }

    function attachTableEvents() {
      document.querySelectorAll('.editBtn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id
          const u = allUsers.find(x => x.id === id)
          if (!u) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö')
          editMode = true
          userIdInput.value = u.id
          usernameInput.value = u.username
          fullNameInput.value = u.full_name
          passwordInput.value = u.password
          roleSelect.value = u.role
        }
      })
      document.querySelectorAll('.deleteBtn').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.dataset.id
          if (!confirm('‡∏•‡∏ö?')) return
          await supabase.from('users').delete().eq('id', id)
          loadUsers()
        }
      })
    }

    searchInput.addEventListener('input', e => {
      const q = e.target.value.toLowerCase()
      const filtered = allUsers.filter(u =>
        u.username.toLowerCase().includes(q) ||
        (u.full_name && u.full_name.toLowerCase().includes(q))
      )
      renderUserTable(filtered)
    })

    userForm.onsubmit = async e => {
      e.preventDefault()
      const payload = {
        username: usernameInput.value,
        full_name: fullNameInput.value,
        password: passwordInput.value,
        role: roleSelect.value
      }
      if (editMode) {
        await supabase.from('users').update(payload).eq('id', userIdInput.value)
        editMode = false
      } else {
        await supabase.from('users').insert([payload])
      }
      userForm.reset()
      loadUsers()
    }

    cancelBtn.onclick = () => {
      editMode = false
      userForm.reset()
    }

    loadUsers()
  </script>
</body>
</html>
