<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <style>
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background-color: rgba(59, 130, 246, 0.5);
      border-radius: 10px;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex">

  <!-- Sidebar -->
  <aside class="w-64 bg-white shadow h-screen sticky top-0 p-6 space-y-4">
    <div class="text-xl font-bold text-blue-600 mb-4">Admin Panel</div>
    <nav class="flex flex-col gap-2">
      <button class="tab-btn text-left px-4 py-2 rounded hover:bg-blue-50" data-target="calendar">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</button>
      <button class="tab-btn text-left px-4 py-2 rounded hover:bg-blue-50" data-target="event">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Event</button>
      <button class="tab-btn text-left px-4 py-2 rounded hover:bg-blue-50 text-blue-700 font-semibold" data-target="user">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
      <button id="logoutBtn" class="text-left px-4 py-2 rounded hover:bg-blue-50 text-red-500 mt-8">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-grow max-w-7xl mx-auto px-4 py-6 space-y-6">

    <!-- ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô -->
    <section id="section-calendar" class="hidden">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-4">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h2>
        <div id="calendar" class="bg-white p-6 rounded-2xl shadow-lg min-h-[600px]"></div>
      </div>
    </section>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Event -->
    <section id="section-event" class="hidden">
      <div class="bg-white p-6 rounded-xl shadow space-y-6">
        <h2 class="text-xl font-semibold">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Event</h2>

        <form id="eventForm" class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <input type="hidden" id="eventId" />
          <input type="text" id="eventTitle" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°" required class="px-4 py-2 border rounded col-span-2" />
          <input type="text" id="eventDescription" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢" class="px-4 py-2 border rounded col-span-2" />
          <label class="flex flex-col">
            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°
            <input type="date" id="eventStart" required class="px-4 py-2 border rounded" />
          </label>
          <label class="flex flex-col">
            ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°
            <input type="time" id="eventStartTime" required class="px-4 py-2 border rounded" />
          </label>
          <label class="flex flex-col">
            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
            <input type="date" id="eventEnd" required class="px-4 py-2 border rounded" />
          </label>
          <label class="flex flex-col">
            ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
            <input type="time" id="eventEndTime" required class="px-4 py-2 border rounded" />
          </label>
          <input type="url" id="eventFileUrl" placeholder="URL ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" class="px-4 py-2 border rounded col-span-4" />
          <div class="col-span-4 flex gap-4">
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded flex-1">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button type="button" id="eventCancelBtn" class="bg-gray-300 px-4 py-2 rounded flex-1">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </form>

        <div id="eventSuccess" class="text-green-600 hidden">‚úîÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>

        <table class="min-w-full table-auto border mt-6">
          <thead class="bg-blue-100">
            <tr>
              <th class="border px-4 py-2">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
              <th class="border px-4 py-2">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</th>
              <th class="border px-4 py-2">‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤)</th>
              <th class="border px-4 py-2">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤)</th>
              <th class="border px-4 py-2">‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</th>
              <th class="border px-4 py-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="eventTableBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
    <section id="section-user">
      <div class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-4">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>

        <input id="searchInput" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="w-full px-4 py-2 border rounded-lg mb-4" />

        <div class="overflow-x-auto">
          <table class="min-w-full table-auto border">
            <thead class="bg-blue-100">
              <tr>
                <th class="border px-4 py-2">Username</th>
                <th class="border px-4 py-2">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°</th>
                <th class="border px-4 py-2">Role</th>
                <th class="border px-4 py-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                <th class="border px-4 py-2">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
          </table>
        </div>

        <form id="userForm" class="space-y-4 mt-6">
          <input type="hidden" id="userId" />
          <input type="text" id="username" placeholder="Username" required class="w-full px-4 py-2 border rounded-lg" />
          <input type="text" id="fullName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°" required class="w-full px-4 py-2 border rounded-lg" />
          <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required class="w-full px-4 py-2 border rounded-lg" />
          <select id="role" class="w-full px-4 py-2 border rounded-lg">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
          <div class="flex gap-4">
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button type="button" id="cancelBtn" class="bg-gray-300 px-4 py-2 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <!-- Script -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    const supabase = createClient(
      'https://yyxovuybwuqvgtikujyi.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5eG92dXlid3Vxdmd0aWt1anlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwODE3MzQsImV4cCI6MjA2NjY1NzczNH0.QgvI_-w55PFXY0oz8U4ZeqFp4RDQlNFEMA4B40kkVtQ'
    )

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå admin
    const user = JSON.parse(localStorage.getItem('user') || '{}')
    if (!user.id || user.role !== 'admin') {
      alert('‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô')
      location.href = 'login.html'
    }

    // Tab control
    const tabButtons = document.querySelectorAll('.tab-btn')
    const sections = {
      calendar: document.getElementById('section-calendar'),
      event: document.getElementById('section-event'),
      user: document.getElementById('section-user')
    }

    let calendarInitialized = false
    let calendar

    tabButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const target = btn.dataset.target

        for (let key in sections) {
          sections[key].classList.toggle('hidden', key !== target)
        }

        tabButtons.forEach(b => b.classList.remove('text-blue-700', 'font-semibold'))
        btn.classList.add('text-blue-700', 'font-semibold')

        if (target === 'calendar' && !calendarInitialized) {
          const { data: events, error } = await supabase.from('events').select('*')
          if (error) return alert('‡πÇ‡∏´‡∏•‡∏î Event ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message)

          calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: 'dayGridMonth',
            locale: 'th',
            headerToolbar: {
              left: 'prev,next today',
              center: 'title',
              right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            events: events.map(ev => ({
              title: ev.title,
              start: ev.start_date + 'T' + (ev.start_time ? ev.start_time.slice(0,5) : '00:00'),
              end: ev.end_date + 'T' + (ev.end_time ? ev.end_time.slice(0,5) : '23:59'),
              url: ev.file_url
            })),
            eventClick(info) {
              if (info.event.url) {
                info.jsEvent.preventDefault()
                window.open(info.event.url, '_blank')
              }
            }
          })
          calendar.render()
          calendarInitialized = true
        }
      })
    })

    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
sections.user.classList.add('hidden')
sections.calendar.classList.remove('hidden')
sections.event.classList.add('hidden')

tabButtons.forEach(b => b.classList.remove('text-blue-700', 'font-semibold'))
document.querySelector('[data-target="calendar"]').classList.add('text-blue-700', 'font-semibold')
document.querySelector('[data-target="calendar"]').click()


    // Logout
    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('user')
      location.href = 'index.html'
    }

    // --- Event Management ---
    const eventForm = document.getElementById('eventForm')
    const eventIdInput = document.getElementById('eventId')
    const eventTitleInput = document.getElementById('eventTitle')
    const eventDescriptionInput = document.getElementById('eventDescription')
    const eventStartInput = document.getElementById('eventStart')
    const eventStartTimeInput = document.getElementById('eventStartTime')
    const eventEndInput = document.getElementById('eventEnd')
    const eventEndTimeInput = document.getElementById('eventEndTime')
    const eventFileUrlInput = document.getElementById('eventFileUrl')
    const eventSuccess = document.getElementById('eventSuccess')
    const eventTableBody = document.getElementById('eventTableBody')
    const eventCancelBtn = document.getElementById('eventCancelBtn')

    let eventEditMode = false
    let eventsCache = []

    async function loadEvents() {
      const { data, error } = await supabase.from('events').select('*').order('start_date', { ascending: true })
      if (error) return alert('‡πÇ‡∏´‡∏•‡∏î Event ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message)
      eventsCache = data
      renderEventTable(data)
      if (calendarInitialized) {
        calendar.removeAllEvents()
        data.forEach(ev => {
          calendar.addEvent({
            id: ev.id,
            title: ev.title,
            start: ev.start_date + 'T' + (ev.start_time ? ev.start_time.slice(0,5) : '00:00'),
            end: ev.end_date + 'T' + (ev.end_time ? ev.end_time.slice(0,5) : '23:59'),
            url: ev.file_url
          })
        })
      }
    }

    function renderEventTable(events) {
      if (!events.length) {
        eventTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`
        return
      }
      eventTableBody.innerHTML = events.map(ev => {
        const startDT = new Date(ev.start_date + 'T' + (ev.start_time ? ev.start_time.slice(0,5) : '00:00'))
        const endDT = new Date(ev.end_date + 'T' + (ev.end_time ? ev.end_time.slice(0,5) : '23:59'))
        return `
          <tr>
            <td class="border px-4 py-2">${ev.title}</td>
            <td class="border px-4 py-2">${ev.description || ''}</td>
            <td class="border px-4 py-2">${startDT.toLocaleDateString('th-TH')} ${startDT.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}</td>
            <td class="border px-4 py-2">${endDT.toLocaleDateString('th-TH')} ${endDT.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}</td>
            <td class="border px-4 py-2">
              ${ev.file_url ? `<a href="${ev.file_url}" target="_blank" class="text-blue-600 underline">‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</a>` : '-'}
            </td>
            <td class="border px-4 py-2 text-center space-x-2">
              <button class="editEventBtn text-blue-600" data-id="${ev.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="deleteEventBtn text-red-600" data-id="${ev.id}">‡∏•‡∏ö</button>
            </td>
          </tr>
        `
      }).join('')
      attachEventTableEvents()
    }

    function attachEventTableEvents() {
      document.querySelectorAll('.editEventBtn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id
          const ev = eventsCache.find(x => x.id == id)
          if (!ev) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Event ‡∏ô‡∏µ‡πâ')
          eventEditMode = true
          eventIdInput.value = ev.id
          eventTitleInput.value = ev.title
          eventDescriptionInput.value = ev.description || ''
          eventStartInput.value = ev.start_date || ''
          eventStartTimeInput.value = ev.start_time ? ev.start_time.slice(0,5) : ''
          eventEndInput.value = ev.end_date || ''
          eventEndTimeInput.value = ev.end_time ? ev.end_time.slice(0,5) : ''
          eventFileUrlInput.value = ev.file_url || ''
          // Switch to event tab
          for (let key in sections) {
            sections[key].classList.toggle('hidden', key !== 'event')
          }
          tabButtons.forEach(b => b.classList.remove('text-blue-700', 'font-semibold'))
          document.querySelector('[data-target="event"]').classList.add('text-blue-700', 'font-semibold')
        }
      })

      document.querySelectorAll('.deleteEventBtn').forEach(btn => {
        btn.onclick = async () => {
          if (!confirm('‡∏•‡∏ö Event ‡∏ô‡∏µ‡πâ?')) return
          const { error } = await supabase.from('events').delete().eq('id', btn.dataset.id)
          if (error) return alert('‡∏•‡∏ö Event ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message)
          loadEvents()
        }
      })
    }

    eventForm.addEventListener('submit', async e => {
  e.preventDefault()

  const payload = {
    title: eventTitleInput.value.trim(),
    description: eventDescriptionInput.value.trim(),
    start_date: combineDateTime(eventStartInput.value, eventStartTimeInput.value),
    end_date: combineDateTime(eventEndInput.value, eventEndTimeInput.value),
    file_url: eventFileUrlInput.value.trim(),
    created_by: user.id
  }

  if (!payload.start_date || !payload.end_date) {
    return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô')
  }

  if (payload.end_date < payload.start_date) {
    return alert('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô')
  }

  if (eventEditMode) {
    const { error } = await supabase.from('events').update(payload).eq('id', eventIdInput.value)
    if (error) return alert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï Event ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message)
    eventEditMode = false
  } else {
    const { error } = await supabase.from('events').insert([payload])
    if (error) return alert('‡∏™‡∏£‡πâ‡∏≤‡∏á Event ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message)
  }

  eventForm.reset()
  eventSuccess.classList.remove('hidden')
  setTimeout(() => eventSuccess.classList.add('hidden'), 3000)
  loadEvents()
})

      // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô Date ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö)
      const startDT = new Date(payload.start_date + 'T' + payload.start_time)
      const endDT = new Date(payload.end_date + 'T' + payload.end_time)
      if (endDT < startDT) {
        return alert('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô')
      }

      if (eventEditMode) {
        const { error } = await supabase.from('events').update(payload).eq('id', eventIdInput.value)
        if (error) return alert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï Event ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message)
        eventEditMode = false
      } else {
        const { error } = await supabase.from('events').insert([payload])
        if (error) return alert('‡∏™‡∏£‡πâ‡∏≤‡∏á Event ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message)
      }

      eventForm.reset()
      eventSuccess.classList.remove('hidden')
      setTimeout(() => eventSuccess.classList.add('hidden'), 3000)
      loadEvents()
    })

    eventCancelBtn.onclick = () => {
      eventEditMode = false
      eventForm.reset()
    }

    // --- User Management ---
    const userForm = document.getElementById('userForm')
    const userIdInput = document.getElementById('userId')
    const usernameInput = document.getElementById('username')
    const fullNameInput = document.getElementById('fullName')
    const passwordInput = document.getElementById('password')
    const roleSelect = document.getElementById('role')
    const cancelBtn = document.getElementById('cancelBtn')
    const searchInput = document.getElementById('searchInput')
    const userTableBody = document.getElementById('userTableBody')

    let usersCache = []
    let userEditMode = false

    async function loadUsers() {
      const { data, error } = await supabase.from('users').select('*').order('created_at', { ascending: true })
      if (error) return alert('‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message)
      usersCache = data
      renderUserTable(data)
    }

    function renderUserTable(users) {
      if (!users.length) {
        userTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`
        return
      }
      userTableBody.innerHTML = users.map(u => `
        <tr>
          <td class="border px-4 py-2">${u.username}</td>
          <td class="border px-4 py-2">${u.full_name || ''}</td>
          <td class="border px-4 py-2">${u.role}</td>
          <td class="border px-4 py-2">${new Date(u.created_at).toLocaleDateString('th-TH')}</td>
          <td class="border px-4 py-2 text-center space-x-2">
            <button class="editUserBtn text-blue-600" data-id="${u.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="deleteUserBtn text-red-600" data-id="${u.id}">‡∏•‡∏ö</button>
          </td>
        </tr>
      `).join('')
      attachUserTableEvents()
    }

    function attachUserTableEvents() {
      document.querySelectorAll('.editUserBtn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id
          const u = usersCache.find(x => x.id == id)
          if (!u) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ')
          userEditMode = true
          userIdInput.value = u.id
          usernameInput.value = u.username
          fullNameInput.value = u.full_name || ''
          passwordInput.value = ''
          roleSelect.value = u.role || 'user'
          // Switch tab user
          for (let key in sections) {
            sections[key].classList.toggle('hidden', key !== 'user')
          }
          tabButtons.forEach(b => b.classList.remove('text-blue-700', 'font-semibold'))
          document.querySelector('[data-target="user"]').classList.add('text-blue-700', 'font-semibold')
        }
      })

      document.querySelectorAll('.deleteUserBtn').forEach(btn => {
        btn.onclick = async () => {
          if (!confirm('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ?')) return
          const { error } = await supabase.from('users').delete().eq('id', btn.dataset.id)
          if (error) return alert('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message)
          loadUsers()
        }
      })
    }

    userForm.addEventListener('submit', async e => {
      e.preventDefault()
      const username = usernameInput.value.trim()
      const full_name = fullNameInput.value.trim()
      const password = passwordInput.value
      const role = roleSelect.value

      if (!username || !full_name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö')

      if (userEditMode) {
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏ñ‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô ‡∏à‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏î‡πâ‡∏ß‡∏¢)
        let payload = { username, full_name, role }
        if (password) payload.password = password
        const { error } = await supabase.from('users').update(payload).eq('id', userIdInput.value)
        if (error) return alert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message)
        userEditMode = false
      } else {
        if (!password) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà')
        const { error } = await supabase.from('users').insert([{ username, full_name, password, role }])
        if (error) return alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message)
      }
      userForm.reset()
      loadUsers()
    })

    cancelBtn.onclick = () => {
      userEditMode = false
      userForm.reset()
    }

    // Search user
    searchInput.addEventListener('input', () => {
      const keyword = searchInput.value.toLowerCase()
      const filtered = usersCache.filter(u =>
        u.username.toLowerCase().includes(keyword) ||
        (u.full_name && u.full_name.toLowerCase().includes(keyword)) ||
        (u.role && u.role.toLowerCase().includes(keyword))
      )
      renderUserTable(filtered)
    })

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    loadEvents()
    loadUsers()
  </script>

</body>
</html>
